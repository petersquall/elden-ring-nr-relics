<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Nightreign Relic Scanner</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192.png">
<link rel="apple-touch-icon" href="assets/icons/icon-192.png">
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- ==================== HOME SCREEN ==================== -->
<div id="screen-home" class="screen active">
  <header class="app-header">
    <h1 class="app-logo"><span class="logo-relic">Relic</span><span class="logo-scanner">Scanner</span><span class="alpha-badge">Alpha v0.2</span></h1>
    <div class="header-actions">
      <span class="relic-count" id="relicCount">0 relics</span>
      <button class="btn-icon btn-help" id="btnHelp" title="How to use">?</button>
      <button class="btn-icon" id="btnExport" title="Export">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </button>
    </div>
  </header>

  <div class="relic-list" id="relicList">
    <!-- Populated by JS -->
  </div>

  <div class="empty-state" id="emptyState">
    <div class="empty-icon">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3"><circle cx="12" cy="12" r="10"/><path d="M8 12l2 2 4-4"/></svg>
    </div>
    <p>No relics scanned yet</p>
    <p class="empty-sub">Tap Scan to start</p>
  </div>

  <button class="fab" id="btnScan">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
    <span>Scan</span>
  </button>
</div>

<!-- ==================== SCANNER SCREEN ==================== -->
<div id="screen-scanner" class="screen">
  <div class="scanner-camera" id="scannerCamera">
    <video id="video" autoplay playsinline muted></video>

    <!-- Dark overlay with crop cutout -->
    <div class="crop-overlay">
      <svg>
        <defs>
          <mask id="cropMask">
            <rect width="100%" height="100%" fill="white"/>
            <rect id="cropCutout" fill="black" rx="4"/>
          </mask>
        </defs>
        <rect width="100%" height="100%" fill="rgba(0,0,0,0.5)" mask="url(#cropMask)"/>
      </svg>
    </div>
    <div class="crop-border" id="cropBorder"></div>
    <div class="crop-resize-handle" id="cropResizeHandle"></div>

    <!-- Scanner top bar -->
    <div class="scanner-top-bar">
      <button class="btn-icon-light" id="btnBackToHome">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
      </button>
      <span class="scan-status" id="scanStatus">Ready</span>
      <button class="btn-icon-light" id="btnFlipCamera">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 16V7a2 2 0 00-2-2H6"/><path d="M4 8v9a2 2 0 002 2h12"/><polyline points="15 4 20 7 15 10"/><polyline points="9 20 4 17 9 14"/></svg>
      </button>
    </div>

    <!-- OCR status -->
    <div class="scanner-bottom-info" id="scannerInfo">Tap Start to begin scanning</div>
  </div>

  <!-- Scanner results panel -->
  <div class="scanner-results" id="scannerResults">
    <!-- Detected relic name -->
    <div class="relic-name-display" id="relicNameDisplay">--</div>

    <!-- Top action bar: scan toggle + save -->
    <div class="scanner-action-bar">
      <button class="btn-toggle-scan" id="btnToggleScan">Start Scan</button>
      <button class="btn-save-relic" id="btnSaveRelic" disabled>Save Relic</button>
    </div>

    <!-- Color + DN row -->
    <div class="color-dn-row">
      <div class="color-buttons" id="colorButtons">
        <button class="color-btn Red" data-color="Red">R</button>
        <button class="color-btn Green" data-color="Green">G</button>
        <button class="color-btn Blue" data-color="Blue">B</button>
        <button class="color-btn Yellow" data-color="Yellow">Y</button>
      </div>
      <label class="dn-toggle">
        <input type="checkbox" id="dnToggle">
        <span>Deep Night</span>
      </label>
    </div>

    <!-- Effect list -->
    <div class="effect-list" id="effectList">
      <div class="no-effects">Point camera at relic effects</div>
    </div>
  </div>

  <!-- Settings gear -->
  <button class="settings-fab" id="btnSettings">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  </button>

  <!-- Settings panel (hidden) -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <h3>Settings</h3>
      <button class="btn-icon" id="btnCloseSettings">&times;</button>
    </div>
    <div class="settings-grid">
      <label>Contrast <span class="val" id="contrastVal">1.4</span>
        <input type="range" id="contrast" min="1.0" max="3.0" step="0.1" value="1.4"></label>
      <label>Threshold <span class="val" id="thresholdVal">0.5</span>
        <input type="range" id="threshold" min="0.1" max="0.9" step="0.05" value="0.5"></label>
      <label>Blur <span class="val" id="blurVal">0.8</span>
        <input type="range" id="blur" min="0" max="3.0" step="0.2" value="0.8"></label>
      <label>Scale <span class="val" id="scaleVal">2</span>x
        <input type="range" id="scale" min="1" max="4" step="0.5" value="2"></label>
      <label>Match threshold <span class="val" id="fuseThreshVal">0.35</span>
        <input type="range" id="fuseThreshold" min="0.1" max="0.8" step="0.05" value="0.35"></label>
      <label>Scan interval <span class="val" id="intervalVal">3</span>s
        <input type="range" id="scanInterval" min="1" max="8" step="0.5" value="3"></label>
      <label>PSM <span class="val" id="psmVal">6</span>
        <select id="psm">
          <option value="3">3 - Auto</option>
          <option value="4">4 - Column</option>
          <option value="6" selected>6 - Block</option>
          <option value="11">11 - Sparse</option>
        </select></label>
      <label class="row-label">
        <input type="checkbox" id="invertCheck"> Invert colors</label>
    </div>
  </div>
</div>

<!-- ==================== EXPORT SCREEN ==================== -->
<div id="screen-export" class="screen">
  <header class="app-header">
    <button class="btn-icon" id="btnBackFromExport">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
    </button>
    <h1>Export</h1>
    <div style="width:36px"></div>
  </header>

  <div class="export-content">
    <div class="export-summary" id="exportSummary">
      <!-- Filled by JS -->
    </div>

    <div class="export-preview">
      <h3>JSON Preview</h3>
      <pre class="json-preview" id="jsonPreview"></pre>
    </div>

    <div class="export-actions">
      <a href="https://relics.pro/my-relics" target="_blank" class="btn-primary btn-full" style="text-align:center;text-decoration:none">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        Open relics.pro
      </a>
      <button class="btn-primary btn-full" id="btnDownloadJSON">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download JSON
      </button>
      <button class="btn-secondary btn-full" id="btnCopyJSON">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Copy to Clipboard
      </button>
      <button class="btn-danger btn-full" id="btnClearAll">Clear All Relics</button>
    </div>
  </div>
</div>

<!-- Help modal -->
<div class="help-overlay" id="helpOverlay" style="display:none">
  <div class="help-modal">
    <div class="help-header">
      <h2>How to Use</h2>
      <button class="btn-icon" id="btnCloseHelp">&times;</button>
    </div>
    <div class="help-content">
      <div class="help-step">
        <div class="help-step-num">1</div>
        <div>
          <h3>Scan your relics</h3>
          <p>Open the game on your TV/monitor and navigate to your relic inventory. Tap <strong>Scan</strong>, point your phone camera at each relic's effect list, and tap <strong>Save Relic</strong>. The app uses OCR to read the effect names and match them to the database.</p>
          <p class="help-tip">Tip: Adjust the crop box to frame just the effects text for best results. You can tweak contrast/threshold in Settings if OCR accuracy is low.</p>
        </div>
      </div>
      <div class="help-step">
        <div class="help-step-num">2</div>
        <div>
          <h3>Export as JSON</h3>
          <p>After scanning your relics, go back to the home screen. Tap the <strong>download icon</strong> in the top-right corner. On the Export page, tap <strong>Download JSON</strong> to save the file to your device.</p>
        </div>
      </div>
      <div class="help-step">
        <div class="help-step-num">3</div>
        <div>
          <h3>Upload to relics.pro</h3>
          <p>Go to <strong>relics.pro/my-relics</strong> (there's a direct link on the Export page). Upload your exported JSON file there to import all your scanned relics.</p>
        </div>
      </div>
      <div class="help-step">
        <div class="help-step-num">4</div>
        <div>
          <h3>Optimize your build</h3>
          <p>On relics.pro you can now use the <strong>build optimizer</strong> to find the best relic combinations for your character based on your actual relic collection.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Hidden canvases -->
<canvas id="captureCanvas" style="display:none"></canvas>
<canvas id="processedCanvas" style="display:none"></canvas>

<!-- Scripts -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/fuse.js@7/dist/fuse.min.js"></script>
<script src="js/effects-db.js"></script>
<script src="js/relics-name-db.js"></script>
<script src="js/ui.js"></script>
<script src="js/preprocessor.js"></script>
<script src="js/camera.js"></script>
<script src="js/ocr.js"></script>
<script src="js/matcher.js"></script>
<script src="js/relic-manager.js"></script>
<script src="js/exporter.js"></script>
<script src="js/app.js"></script>
</body>
</html>
